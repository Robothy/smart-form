version: '3.8'
services:
  dev:
    build:
      context: .
    container_name: simple-form-dev
    volumes:
      - ..:/workspace:cached
      - ${USERPROFILE}/.ssh:/tmp/host-ssh:ro
      - ${USERPROFILE}/ca-certificates:/tmp/ca-certificates:ro
    working_dir: /workspace
    tty: true
    stdin_open: true
    environment:
      - USER=dev
      - DISABLE_ERROR_REPORTING=1
      - DISABLE_TELEMETRY=1
      - CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1
      - MCP_TIMEOUT=60000
      - ANTHROPIC_AUTH_TOKEN=${ZHIPU_API_KEY}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL}
      - ANTHROPIC_DEFAULT_SONNET_MODEL=${ANTHROPIC_DEFAULT_SONNET_MODEL}
      - ANTHROPIC_DEFAULT_OPUS_MODEL=${ANTHROPIC_DEFAULT_OPUS_MODEL}
      - ANTHROPIC_DEFAULT_HAIKU_MODEL=${ANTHROPIC_DEFAULT_HAIKU_MODEL}
      - NODE_OPTIONS=--dns-result-order=ipv4first
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_ROBOTHY_ACCESS_TOKEN}
      - CONTEXT7_API_KEY=${CONTEXT7_API_KEY}
      - WATCHPACK_POLLING=true
    command: [
      "/bin/bash", 
      "-c",
      "mkdir -p ~/.ssh && \
       if [ -d /tmp/host-ssh ]; then sudo cp -r /tmp/host-ssh/* ~/.ssh/ && sudo chown -R dev:dev ~/.ssh; fi && \
       chmod 700 ~/.ssh && \
       chmod 600 ~/.ssh/* 2>/dev/null || true && \
       if [ -d /tmp/ca-certificates ]; then \
         sudo cp /tmp/ca-certificates/*.crt /usr/local/share/ca-certificates/ 2>/dev/null || true && \
         sudo update-ca-certificates; \
       fi && \
       git config --global --add safe.directory /workspace && \
       git config --global user.name 'robothy' && \
       git config --global user.email 'robothyluo@gmail.com' && \
       /bin/bash"
    ]
